<?xml version="1.0" encoding="utf-8"?>
<!--
***********************************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the MIT License.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  
  <PropertyGroup>
    <NoPackageAnalysis>true</NoPackageAnalysis>
    <IncludeBuildOutput>true</IncludeBuildOutput>
    <IncludeContentInPack>false</IncludeContentInPack>
    <PackageOutputPath>$(RepoRoot)\PkgOut</PackageOutputPath>
  </PropertyGroup>

  <ItemGroup Condition="'$(IsPackable)' == 'true'">
    <PackageReference Include="platyPS" Version="0.9.0">
      <PrivateAssets>All</PrivateAssets>
    </PackageReference>
  </ItemGroup>

  <PropertyGroup>
    <BeforePack>$(BeforePack);UpdatePSManifest;GeneratePSHelp</BeforePack>
  </PropertyGroup>

  
  <Target Name="AddMoreProjectFiles" AfterTargets="_GetPackageFiles" Condition="'$(IsPackable)' == 'true'">

    <ItemGroup>
      
      <_PackageFiles Include="$(OutputPath)\WindowsAuthenticator\**\*.*" Condition="Exists('$(OutputPath)\WindowsAuthenticator')">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath>lib\$(TargetFramework)\WindowsAuthenticator</PackagePath>
      </_PackageFiles>
      
      <_PackageFiles Include="$(OutputPath)\settings.json" Condition="Exists('$(OutputPath)\settings.json') AND '$(NoDependentAssemblies)' != 'true'">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath>lib\$(TargetFramework)</PackagePath>
      </_PackageFiles>
      
      <_PackageFiles Include="@(_ResolveAssemblyReferenceResolvedFiles)" Condition="'$(NoDependentAssemblies)' != 'true'">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath>lib\$(TargetFramework)</PackagePath>
      </_PackageFiles>
      
      <_PackageFiles Include="$(OutputPath)\$(LangName)\**\*.*" Condition="'$(NoHelpGen)' != 'true'">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath>$(LangName)</PackagePath>
      </_PackageFiles>
      
      <_PackageFiles Include="$(OutputPath)\$(PackageId).psd1">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath></PackagePath>
      </_PackageFiles>
      
      <_PackageFiles Include="$(OutputPath)\$(AssemblyName).types.ps1xml" Condition="Exists('$(OutputPath)\$(AssemblyName).types.ps1xml')">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath></PackagePath>
      </_PackageFiles>

      <_PackageFiles Include="$(OutputPath)\$(AssemblyName).format.ps1xml" Condition="Exists('$(OutputPath)\$(AssemblyName).format.ps1xml')">
        <BuildAction>Content</BuildAction>
        <Pack>true</Pack>
        <PackagePath></PackagePath>
      </_PackageFiles>
      
    </ItemGroup>
    
  </Target>

  
  <Target Name="GetPSModuleSettings" DependsOnTargets="RunResolvePackageDependencies" Condition="'$(IsPackable)' == 'true'">
    
    <ItemGroup>
      <PlatyPSPkg Include="@(PackageDefinitions)" Condition="'%(PackageDefinitions.Name)' == 'platyPS'" KeepMetadata="ResolvedPath" />
      <PSDFile Include="$(OutputPath)\$(PackageId).psd1" />
    </ItemGroup>

    <PropertyGroup>
      <PlatyPSPath>%(PlatyPSPkg.ResolvedPath)</PlatyPSPath>
    </PropertyGroup>

    <!--<Message Text="PlatyPS Path = $(PlatyPSPath)" Importance="high" />-->
  </Target>

  
  <Target Name="GenerateMarkdownHelp" AfterTargets="AfterBuild" DependsOnTargets="GetPSModuleSettings" Condition="'$(IsPackable)' == 'true' AND '$(NoHelpGen)' != 'true'">

    <Exec Command="$(PowerShellExe) $(PowerShellCommonArgs) -Command &quot;&amp; { &amp;&apos;$(ScriptsRoot)GenerateHelp.ps1&apos; -ModulePath &apos;%(PSDFile.FullPath)&apos; -PathToPlatyPS &apos;$(PlatyPSPath)&apos; -ProjectRoot &apos;$(MSBuildProjectDirectory)&apos; -Language &apos;$(LangName)&apos; -GenerateMarkdown -DependentAssemblies &apos;@(_ResolveAssemblyReferenceResolvedFiles)&apos;} &quot;" />

  </Target>

  
  <Target Name="UpdatePSManifest" DependsOnTargets="GetPSModuleSettings" Condition="'$(IsPackable)' == 'true'">

    <Exec Command="$(PowerShellExe) $(PowerShellCommonArgs) -Command &quot;&amp; { &amp;&apos;$(ScriptsRoot)UpdatePSModuleManifest.ps1&apos; -ModulePath &apos;%(PSDFile.FullPath)&apos; -TargetFramework &apos;$(TargetFramework)&apos; -Version &apos;$(PackageVersion)&apos; -ReleaseNotes &apos;$(PackageReleaseNotes)&apos;} &quot;" />

  </Target>
  
  
  <Target Name="GeneratePSHelp" DependsOnTargets="GetPSModuleSettings" Condition="'$(IsPackable)' == 'true' AND '$(NoHelpGen)' != 'true'">
    
    <Exec Command="$(PowerShellExe) $(PowerShellCommonArgs) -Command &quot;&amp; { &amp;&apos;$(ScriptsRoot)GenerateHelp.ps1&apos; -PathToPlatyPS &apos;$(PlatyPSPath)&apos; -ProjectRoot &apos;$(MSBuildProjectDirectory)&apos; -OutputPath &apos;$(OutputPath)&apos; -GenerateExternalHelp -Language &apos;$(LangName)&apos;} &quot;" />
    
  </Target>
  
</Project>